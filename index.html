<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Wizard Chess Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  text-align: center;
  padding: 20px;
}
button {
  padding: 10px 16px;
  margin: 6px;
  font-size: 15px;
  cursor: pointer;
}
input {
  padding: 8px;
  font-size: 15px;
  width: 240px;
}
#log, #sim {
  text-align: left;
  margin: 15px auto;
  padding: 10px;
  max-width: 900px;
  height: 160px;
  overflow-y: auto;
  background: #020617;
  border: 1px solid #334155;
  white-space: pre-wrap;
}
.badge {
  padding: 4px 10px;
  border-radius: 12px;
  margin-left: 6px;
}
.white { background: #f8fafc; color: #020617; }
.black { background: #020617; color: #f8fafc; border: 1px solid #94a3b8; }
.ok { color: #22c55e; }
.bad { color: #ef4444; }
.warn { color: #facc15; }
</style>
</head>

<body>

<h1>‚ôü Wizard Chess Controller</h1>

<div>
  Turn:
  <span id="turnBadge" class="badge white">WHITE</span>
</div>

<br>

<button id="connectBtn">Connect Arduino</button>
<button id="listenBtn">üé§ Start Listening</button>
<button id="stopBtn" disabled>Stop Listening</button>

<br><br>

<input id="manualInput" placeholder="E2 to E4" />
<button id="sendBtn">Send Move</button>

<div id="log"></div>

<h3>Simulation Output</h3>
<div id="sim"></div>

<script>
/* ===================== GLOBAL STATE ===================== */
let port = null;
let writer = null;
let recognition = null;
let listening = false;
let simulationMode = false;
let currentTurn = "WHITE";

/* ===================== UI HELPERS ===================== */
const logEl = document.getElementById("log");
const simEl = document.getElementById("sim");
const turnBadge = document.getElementById("turnBadge");

function log(msg, cls="") {
  logEl.innerText += msg + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

function sim(msg) {
  simEl.innerText += msg + "\n";
  simEl.scrollTop = simEl.scrollHeight;
}

function toggleTurn() {
  currentTurn = currentTurn === "WHITE" ? "BLACK" : "WHITE";
  turnBadge.textContent = currentTurn;
  turnBadge.className = "badge " + (currentTurn === "WHITE" ? "white" : "black");
}

/* ===================== HARDWARE CHECKS ===================== */
async function checkMicrophone() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    stream.getTracks().forEach(t => t.stop());
    log("‚úî Microphone detected", "ok");
  } catch {
    log("‚ùå Microphone not available", "bad");
  }
}

function checkSerialSupport() {
  if (!("serial" in navigator)) {
    log("‚ùå Web Serial not supported in this browser", "bad");
    return false;
  }
  return true;
}

/* ===================== ARDUINO ===================== */
async function connectArduino() {
  if (!checkSerialSupport()) {
    askSimulation();
    return;
  }
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 9600 });
    writer = port.writable.getWriter();
    log("‚úî Arduino connected", "ok");
  } catch {
    log("‚ö† Arduino not connected", "warn");
    askSimulation();
  }
}

function askSimulation() {
  const useSim = confirm("Arduino not connected.\nStart simulation mode?");
  simulationMode = useSim;
  if (useSim) log("üß™ Simulation mode enabled", "warn");
}

/* ===================== MOVE PARSING ===================== */
function normalizeSpeech(text) {
  text = text.toLowerCase()
    .replace(/-/g, " ")
    .replace("two", "2")
    .replace("four", "4")
    .replace("one", "1")
    .replace("three", "3")
    .replace("five", "5")
    .replace("six", "6")
    .replace("seven", "7")
    .replace("eight", "8");

  const match = text.match(/([a-h][1-8])\s*(?:to| )\s*([a-h][1-8])/);
  if (!match) return null;

  return [match[1].toUpperCase(), match[2].toUpperCase()];
}

/* ===================== SEND MOVE ===================== */
async function sendMove(from, to) {
  if (currentTurn === "WHITE" && from[1] === "7") {
    log("‚ùå Black tried to move on White turn");
    return;
  }
  if (currentTurn === "BLACK" && from[1] === "2") {
    log("‚ùå White tried to move on Black turn");
    return;
  }

  if (simulationMode || !writer) {
    sim(`SIM MOVE ${from} ‚Üí ${to}`);
  } else {
    await writer.write(new TextEncoder().encode(`${from},${to}\n`));
    log(`‚û° Sent to Arduino: ${from},${to}`);
  }

  toggleTurn();
}

/* ===================== SPEECH ===================== */
function startListening() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    alert("Speech recognition not supported");
    return;
  }
  recognition = new SR();
  recognition.continuous = true;
  recognition.lang = "en-US";

  recognition.onresult = e => {
    const t = e.results[e.results.length - 1][0].transcript;
    log("üé§ " + t);
    const move = normalizeSpeech(t);
    if (move) sendMove(move[0], move[1]);
    else log("‚ö† Could not understand move");
  };

  recognition.start();
  listening = true;
  document.getElementById("listenBtn").disabled = true;
  document.getElementById("stopBtn").disabled = false;
}

function stopListening() {
  if (recognition) recognition.stop();
  listening = false;
  document.getElementById("listenBtn").disabled = false;
  document.getElementById("stopBtn").disabled = true;
}

/* ===================== MANUAL ===================== */
document.getElementById("sendBtn").onclick = () => {
  const v = document.getElementById("manualInput").value;
  const move = normalizeSpeech(v);
  if (!move) return log("‚ùå Invalid move");
  sendMove(move[0], move[1]);
};

/* ===================== INIT ===================== */
document.getElementById("connectBtn").onclick = connectArduino;
document.getElementById("listenBtn").onclick = startListening;
document.getElementById("stopBtn").onclick = stopListening;

checkMicrophone();
checkSerialSupport();
log("Ready. White moves first.");
</script>

</body>
</html>
