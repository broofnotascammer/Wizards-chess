<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wizard Chess â€“ Whisper Voice Control</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #0f0;
      padding: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-right: 10px;
      cursor: pointer;
    }
    #log {
      margin-top: 20px;
      background: #000;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      border: 1px solid #0f0;
    }
  </style>
</head>
<body>

<h2>ðŸ§™ Wizard Chess â€“ Whisper Voice Control</h2>

<button id="recordBtn">ðŸŽ™ Record Command</button>

<div id="log"></div>

<script type="module">
  import { pipeline } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2";

  const log = (msg) => {
    const div = document.getElementById("log");
    div.innerHTML += msg + "<br>";
    div.scrollTop = div.scrollHeight;
  };

  log("Loading Whisper modelâ€¦ please wait (first time only)");

  // Load Whisper model (small & fast)
  const transcriber = await pipeline(
    "automatic-speech-recognition",
    "Xenova/whisper-tiny.en"
  );

  log("Whisper ready âœ…");

  let mediaRecorder;
  let audioChunks = [];

  document.getElementById("recordBtn").onclick = async () => {
    audioChunks = [];

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = async () => {
      log("Transcribingâ€¦");

      const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
      const arrayBuffer = await audioBlob.arrayBuffer();
      const audioData = new Float32Array(arrayBuffer);

      const result = await transcriber(audioData);
      const text = result.text.toUpperCase();

      log("Heard: " + text);

      // Parse chess move like "E2 TO E4"
      const match = text.match(/([A-H][1-8]).*([A-H][1-8])/);
      if (match) {
        const move = `${match[1]},${match[2]}`;
        log("Parsed Move âœ…: " + move);

        // TODO: send move to Arduino via Web Serial
        // sendToArduino(move);

      } else {
        log("âŒ Could not parse move");
      }
    };

    mediaRecorder.start();
    log("Recordingâ€¦ speak now");

    // Record for 3 seconds
    setTimeout(() => {
      mediaRecorder.stop();
      log("Recording stopped");
    }, 3000);
  };
</script>

</body>
</html>
