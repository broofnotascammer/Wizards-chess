<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Magic Chess Voice Control</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    button { font-size: 16px; padding: 8px 14px; margin: 6px; }
    #log, #simOut { 
      text-align: left; max-width: 900px; margin: auto; 
      overflow: auto; background: #fafafa; border: 1px solid #ddd; 
      padding: 8px; white-space: pre-wrap; font-size: 14px; 
    }
    #log { height: 180px; }
    #simOut { height: 100px; border: 1px dashed #bbb; background: #fffbea; }
  </style>
</head>
<body>

<h1>Magic Chess Voice Control</h1>

<button id="connect">Connect Arduino</button>
<button id="start">Start Listening</button>
<button id="resetFail">Reset Arduino Check</button>
<div id="status"></div>

<h3>Activity Log</h3>
<div id="log"></div>

<h3>Simulation Output</h3>
<div id="simOut"></div>

<script>
  let port = null, writer = null;
  let arduinoCheckCount = 0;
  let arduinoConnected = false;
  const MAX_ASK = 3;

  function log(msg) {
    const el = document.getElementById("log");
    el.innerText += msg + "\n";
    el.scrollTop = el.scrollHeight;
    console.log(msg);
  }

  function simWrite(msg) {
    const el = document.getElementById("simOut");
    el.innerText += msg + "\n";
    el.scrollTop = el.scrollHeight;
  }

  function setStatus(msg) {
    document.getElementById("status").innerText = msg;
  }

  async function connectArduino() {
    if (!('serial' in navigator)) {
      setStatus("Web Serial not supported (Chrome/Edge)");
      log("Web Serial API not available.");
      return;
    }
    try {
      log("Requesting Arduino port...");
      port = await navigator.serial.requestPort();
      await port.open({ baudRate: 9600 });
      writer = port.writable.getWriter();
      arduinoConnected = true;
      setStatus("Arduino Connected!");
      log("âœ… Arduino connected");
    } catch (e) {
      arduinoConnected = false;
      setStatus("Arduino connection failed");
      log("â›” Connection failed: " + e.message);
    }
  }

  async function sendToArduino(msg) {
    if (!arduinoConnected) {
      log("âš  Arduino not connected â†’ running simulation");
      simWrite("SIMULATED RX: " + msg);
      simWrite("SIMULATED TX: OK");
      return;
    }
    try {
      const data = new TextEncoder().encode(msg + "\n");
      await writer.write(data);
      log("âž¡ Sent to Arduino: " + msg);
    } catch (e) {
      log("âš  Arduino write failed, switching to simulation");
      arduinoConnected = false;
      askUseSimulation();
    }
  }

  function askUseSimulation() {
    if (arduinoCheckCount < MAX_ASK) {
      arduinoCheckCount++;
      if (confirm("Arduino not responding. Try again? (" + arduinoCheckCount + "/" + MAX_ASK + ")")) {
        connectArduino();
      } else {
        log("Simulation activated by user.");
      }
    } else {
      log("Max Arduino prompts reached â†’ using simulation.");
    }
  }

  document.getElementById("resetFail").addEventListener("click", () => {
    arduinoCheckCount = 0;
    log("ðŸš© Arduino retry count reset.");
  });

  function parseMoveText(text) {
    text = text.trim().toLowerCase();
    // E2 to E4, E2 2 E4, e2e4, e22e4 etc.
    const letters = text.match(/[a-h]/g) || [];
    const nums = text.match(/[1-8]/g) || [];
    // build best guess: from letter+num to next letter+num
    if (letters.length >= 2 && nums.length >= 2) {
      let from = letters[0].toUpperCase() + nums[0];
      let to   = letters[1].toUpperCase() + nums[1];
      return [from, to];
    }
    return null;
  }

  function startListening() {
    if (!("webkitSpeechRecognition" in window || "SpeechRecognition" in window)) {
      log("SpeechRecognition not supported; try Chrome/Edge.");
      return;
    }
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const r = new SpeechRecognition();
    r.continuous = true;
    r.interimResults = false;
    r.lang = "en-US";

    r.onresult = (event) => {
      const transcript = event.results[event.results.length - 1][0].transcript;
      log("ðŸŽ¤ Heard: " + transcript);
      const result = parseMoveText(transcript);
      if (result) {
        const [from, to] = result;
        log(`â™Ÿ Parsed Move: ${from} â†’ ${to}`);
        sendToArduino(`${from},${to}`);
      } else {
        log("â— Could not interpret move (try 'move E2 to E4')");
      }
    };

    r.onerror = (e) => log("Speech error: " + e.error);
    r.onend = () => log("Voice listening ended.");

    r.start();
    log("ðŸŽ§ Listening for moves...");
  }

  document.getElementById("connect").addEventListener("click", connectArduino);
  document.getElementById("start").addEventListener("click", startListening);

  setStatus("Ready â€” connect Arduino then start listening.");
  log("Site loaded. Use Chrome/Edge with Web Serial (Web Serial API) support.");  
</script>

</body>
</html>
